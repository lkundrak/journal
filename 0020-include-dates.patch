From 58e1651ca50cda0b57ddc1f65f6be73c8f3a3b78 Mon Sep 17 00:00:00 2001
From: lkundrak <lkundrak>
Date: Thu, 27 Mar 2008 22:40:54 +0000
Subject: [PATCH 20/88] Include dates

---
 scripts/blogpage.awk    |   27 +++++++++++++++++++++++----
 scripts/genrss.pl       |    1 +
 templates/page.template |    6 +++++-
 3 files changed, 29 insertions(+), 5 deletions(-)

diff --git a/scripts/blogpage.awk b/scripts/RCS/blogpage.awk
index aad4027..6a5220c 100644
--- a/scripts/blogpage.awk
+++ b/scripts/blogpage.awk
@@ -1,4 +1,13 @@
 BEGIN {
+	cmd = "rlog "ARGV[2];
+	while (cmd |getline) {
+		if (gsub ("^date: ", "")) {
+			gsub (";.*", "");
+			if (!last) last = $0
+			first = $0;
+		}
+	}
+
 	if (!ARGV[2]) {
 		print "No input files" |"cat 1>&2";
 		exit 1;
@@ -14,10 +23,7 @@ BEGIN {
 	}
 }
 
-
-/@TITLE@/ {
-	gsub ("@TITLE@", title);
-}
+# Block replacements
 
 /@BODY@/ {
 	system ("perl scripts/wiki2html.pl <"ARGV[2]);
@@ -28,8 +34,15 @@ BEGIN {
 /@HEADLINES@/ {
 	for (i = 2; ARGV[i]; i++) {
 		print "<hr>";
+
+		# Last modification date
+		system ("LANG=C date -r "ARGV[i]);
+
+		# Caption and text
 		system ("awk '/<!-- break -->/ {exit} {print $0}' "ARGV[i]\
 			"| perl scripts/wiki2html.pl");
+
+		# Read more link
 		link = ARGV[i];
 		gsub (".cocot", ".html", link);
 		gsub (".*", "<a href=\"&\">Read more...</a>", link);
@@ -40,5 +53,11 @@ BEGIN {
 }
 
 {
+	# Inline replacements
+
+	gsub ("@FIRST@", first);
+	gsub ("@LAST@", last);
+	gsub ("@TITLE@", title);
+
 	print $0;
 }
diff --git a/scripts/genrss.pl b/scripts/RCS/genrss.pl
index cef05d2..15dfbf3 100644
--- a/scripts/genrss.pl
+++ b/scripts/genrss.pl
@@ -46,6 +46,7 @@ foreach my $file (@ARGV) {
 		title		=> $title,
 		permaLink	=> $base.$html,
 		description	=> $desc,
+		pubDate		=> `LANG=C date +'%a, %d %b %Y %T %z' -r $file`,
 	);
 
 	close (BLOG);
diff --git a/templates/page.template b/templates/RCS/page.template
index fb07c9d..89a2fae 100644
--- a/templates/page.template
+++ b/templates/page.template
@@ -11,7 +11,11 @@
 <body>
 	<h1>lkundrak's web log</h1>
 
-	<a href="..">Back to index...</a>
+	<a href="../index.html">Back to index...</a>
+	<dl>
+		<dt>First published</dt><dd>@FIRST@</dd>
+		<dt>Last changed</dt><dd>@LAST@</dd>
+	</dl>
 	<hr>
 
 	@BODY@
-- 
1.6.5.2

